<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Deriv Bot</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
    <header>
        <h1>Advanced Deriv Bot</h1>
        <div class="connection-status">
            <span id="connection-status">Disconnected</span>
            <span id="status-indicator" class="status-indicator"></span>
        </div>
    </header>
    <main>
        <section class="control-panel">
            <h2>Control Panel</h2>
            <div class="form-group">
                <label for="app-id">App ID:</label>
                <input type="number" id="app-id" value="1089" aria-label="Deriv App ID">
            </div>
            <div class="form-group">
                <label for="api-token">API Token:</label>
                <input type="text" id="api-token" aria-label="Deriv API Token">
            </div>
            <div class="form-group">
                <button id="connect-btn" aria-label="Connect to Deriv API">Connect</button>
                <button id="start-btn" aria-label="Start trading">Start Trading</button>
                <button id="stop-btn" disabled aria-label="Stop trading">Stop Trading</button>
                <button id="reset-btn" aria-label="Reset statistics">Reset Stats</button>
                <button id="backtest-btn" aria-label="Run backtest">Run Backtest</button>
            </div>
        </section>

        <section class="config-panel">
            <h2>Configuration</h2>
            <div class="form-group">
                <label for="strategy-select">Strategy:</label>
                <select id="strategy-select" aria-label="Trading strategy">
                    <option value="martingale">Martingale</option>
                    <option value="dalembert">D'Alembert</option>
                    <option value="trend-follow">Trend Following</option>
                    <option value="mean-reversion">Mean Reversion</option>
                    <option value="rsi-strategy">RSI Strategy</option>
                    <option value="grid">Grid</option>
                    <option value="arbitrage">Arbitrage</option>
                    <option value="ml-based">ML-Based</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="form-group">
                <label for="symbols">Symbols:</label>
                <select id="symbols" multiple aria-label="Market symbols">
                    <option value="R_10">R_10</option>
                    <option value="R_25">R_25</option>
                    <option value="R_50">R_50</option>
                    <option value="R_100">R_100</option>
                </select>
            </div>
            <div class="form-group">
                <label for="trade-type">Trade Type:</label>
                <select id="trade-type" aria-label="Trade type">
                    <option value="CALL">CALL</option>
                    <option value="PUT">PUT</option>
                </select>
            </div>
            <div class="form-group">
                <label for="duration">Duration (s):</label>
                <input type="number" id="duration" value="60" aria-label="Trade duration in seconds">
            </div>
            <div class="form-group">
                <label for="stake">Stake ($):</label>
                <input type="number" id="stake" value="1" step="0.1" aria-label="Trade stake">
            </div>
            <div class="form-group">
                <label for="max-loss">Max Loss ($):</label>
                <input type="number" id="max-loss" value="50" aria-label="Maximum loss">
            </div>
            <div class="form-group">
                <label for="max-profit">Max Profit ($):</label>
                <input type="number" id="max-profit" value="100" aria-label="Maximum profit">
            </div>
            <div class="form-group">
                <label for="max-trades">Max Trades:</label>
                <input type="number" id="max-trades" value="50" aria-label="Maximum number of trades">
            </div>
            <div class="form-group">
                <label for="multiplier">Martingale Multiplier:</label>
                <input type="number" id="multiplier" value="2.1" step="0.1" aria-label="Martingale multiplier">
            </div>
            <div class="form-group">
                <label for="max-drawdown">Max Drawdown (%):</label>
                <input type="number" id="max-drawdown" value="20" aria-label="Maximum drawdown percentage">
            </div>
            <div class="form-group">
                <label for="max-consecutive-losses">Max Consecutive Losses:</label>
                <input type="number" id="max-consecutive-losses" value="5" aria-label="Maximum consecutive losses">
            </div>
            <div class="form-group">
                <label for="cooldown-period">Cooldown Period (ms):</label>
                <input type="number" id="cooldown-period" value="300000" aria-label="Cooldown period in milliseconds">
            </div>
            <div class="form-group">
                <label for="position-sizing">Position Sizing:</label>
                <select id="position-sizing" aria-label="Position sizing strategy">
                    <option value="kelly">Kelly Criterion</option>
                    <option value="fixed">Fixed Fraction</option>
                    <option value="volatility">Volatility Adjusted</option>
                </select>
            </div>
            <div class="form-group">
                <label for="fixed-fraction">Fixed Fraction:</label>
                <input type="number" id="fixed-fraction" value="0.02" step="0.01" aria-label="Fixed fraction for position sizing">
            </div>
            <div class="form-group">
                <label for="custom-strategy-rules">Custom Rules (JSON):</label>
                <textarea id="custom-strategy-rules" aria-label="Custom strategy rules in JSON">[]</textarea>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="multi-timeframe" checked aria-label="Use multi-timeframe analysis"> Multi-Timeframe</label>
                <label><input type="checkbox" id="dynamic-switching" checked aria-label="Use dynamic strategy switching"> Dynamic Switching</label>
                <label><input type="checkbox" id="stop-loss-enabled" checked aria-label="Enable stop loss"> Stop Loss</label>
                <label><input type="checkbox" id="take-profit-enabled" checked aria-label="Enable take profit"> Take Profit</label>
                <label><input type="checkbox" id="use-candle-patterns" checked aria-label="Use candle patterns"> Candle Patterns</label>
            </div>
            <div class="form-group">
                <label for="candle-timeframe">Candle Timeframe (s):</label>
                <input type="number" id="candle-timeframe" value="60" aria-label="Candle timeframe in seconds">
            </div>
            <div class="form-group">
                <label for="chart-type">Chart Type:</label>
                <select id="chart-type" aria-label="Chart type">
                    <option value="line">Line</option>
                    <option value="candlestick">Candlestick</option>
                </select>
            </div>
        </section>

        <section class="data-management">
            <h2>Data Management</h2>
            <div class="form-group">
                <label for="data-type">Data Type:</label>
                <select id="data-type" aria-label="Data type to view">
                    <option value="ticks">Ticks</option>
                    <option value="candles">Candles</option>
                    <option value="trades">Trades</option>
                </select>
                <button id="view-data" aria-label="View selected data">View Data</button>
            </div>
            <div class="form-group">
                <label for="import-data">Import Data:</label>
                <input type="file" id="import-data" accept=".json" aria-label="Import data file">
            </div>
            <table id="data-table">
                <thead id="data-table-header"></thead>
                <tbody id="data-table-body"></tbody>
            </table>
            <div class="pagination" id="pagination"></div>
        </section>

        <section class="trading-stats">
            <h2>Trading Statistics</h2>
            <div class="stats-grid">
                <div class="stat">
                    <span class="stat-label">Total Trades:</span>
                    <span class="stat-value" id="total-trades">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Wins:</span>
                    <span class="stat-value" id="wins">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Losses:</span>
                    <span class="stat-value" id="losses">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Win Rate:</span>
                    <span class="stat-value" id="win-rate">0%</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Current Streak:</span>
                    <span class="stat-value" id="current-streak">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total P&L:</span>
                    <span class="stat-value" id="total-pnl">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Balance:</span>
                    <span class="stat-value" id="balance">$0.00</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Last Trade:</span>
                    <span class="stat-value" id="last-trade">-</span>
                </div>
            </div>
            <table class="strategy-table">
                <thead>
                    <tr>
                        <th>Strategy</th>
                        <th>Wins</th>
                        <th>Losses</th>
                        <th>Win Rate</th>
                    </tr>
                </thead>
                <tbody id="strategy-stats-body"></tbody>
            </table>
        </section>

        <section class="market-data">
            <h2>Market Data</h2>
            <div class="stats-grid">
                <div class="stat">
                    <span class="stat-label">Current Price:</span>
                    <span class="stat-value" id="current-price">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">RSI:</span>
                    <span class="stat-value" id="rsi-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Moving Average:</span>
                    <span class="stat-value" id="ma-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Volatility:</span>
                    <span class="stat-value" id="volatility-value">0%</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Bollinger Upper:</span>
                    <span class="stat-value" id="bollinger-upper">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Bollinger Middle:</span>
                    <span class="stat-value" id="bollinger-middle">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Bollinger Lower:</span>
                    <span class="stat-value" id="bollinger-lower">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">MACD Line:</span>
                    <span class="stat-value" id="macd-line">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">MACD Signal:</span>
                    <span class="stat-value" id="macd-signal">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">MACD Histogram:</span>
                    <span class="stat-value" id="macd-histogram">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Stochastic %K:</span>
                    <span class="stat-value" id="stochastic-k">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Stochastic %D:</span>
                    <span class="stat-value" id="stochastic-d">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">ADX:</span>
                    <span class="stat-value" id="adx-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">OBV:</span>
                    <span class="stat-value" id="obv-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Sentiment:</span>
                    <span class="stat-value" id="sentiment-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Candle Pattern:</span>
                    <span class="stat-value" id="candle-pattern">None</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Candle Open:</span>
                    <span class="stat-value" id="candle-open">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Candle High:</span>
                    <span class="stat-value" id="candle-high">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Candle Low:</span>
                    <span class="stat-value" id="candle-low">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Candle Close:</span>
                    <span class="stat-value" id="candle-close">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">News Event:</span>
                    <span class="stat-value" id="news-event">None</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Volatility Spike:</span>
                    <span class="stat-value" id="volatility-spike">No</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Volatility Trend:</span>
                    <span class="stat-value" id="volatility-trend">Stable</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Market Trend:</span>
                    <span class="stat-value" id="market-trend">Sideways</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="price-chart" aria-label="Price chart"></canvas>
            </div>
            <table class="correlation-table">
                <thead>
                    <tr>
                        <th>Symbol Pair</th>
                        <th>Correlation</th>
                    </tr>
                </thead>
                <tbody id="correlation-body"></tbody>
            </table>
        </section>

        <section class="ml-insights">
            <h2>ML Insights</h2>
            <div class="stats-grid">
                <div class="stat">
                    <span class="stat-label">Prediction Confidence:</span>
                    <span class="stat-value" id="ml-confidence">0%</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Top Feature:</span>
                    <span class="stat-value" id="ml-top-feature">None</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="ml-feature-chart" aria-label="ML feature importance chart"></canvas>
            </div>
        </section>

        <section class="log-section">
            <h2>Logs</h2>
            <button id="clear-log" aria-label="Clear logs">Clear Log</button>
            <div id="log-content" class="log-content" role="log" aria-live="polite"></div>
        </section>
    </main>
    <script>
        /**
         * Update price chart using Chart.js
         */
        let priceChart = null;
        function updatePriceChart(candles, symbol) {
            const ctx = document.getElementById('price-chart')?.getContext('2d');
            if (!ctx) {
                console.warn('Price chart canvas not found');
                return;
            }

            const labels = candles.map(c => new Date(c.timestamp).toLocaleTimeString());
            const data = candles.map(c => c.close);

            if (!priceChart) {
                priceChart = new Chart(ctx, {
                    type: window.derivBot?.config.chartType || 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: `${symbol} Price`,
                            data,
                            borderColor: 'var(--primary-color)',
                            backgroundColor: 'transparent',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'Time' } },
                            y: { title: { display: true, text: 'Price' } }
                        }
                    }
                });
            } else {
                priceChart.data.labels = labels;
                priceChart.data.datasets[0].data = data;
                priceChart.update();
            }
        }

        /**
         * Update ML feature importance chart
         */
        let mlChart = null;
        function updateMLFeatureChart(featureImportance) {
            const ctx = document.getElementById('ml-feature-chart')?.getContext('2d');
            if (!ctx) {
                console.warn('ML feature chart canvas not found');
                return;
            }

            const labels = Object.keys(featureImportance);
            const data = Object.values(featureImportance);

            if (!mlChart) {
                mlChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Feature Importance',
                            data,
                            backgroundColor: 'var(--primary-color)',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Importance' } }
                        }
                    }
                });
            } else {
                mlChart.data.labels = labels;
                mlChart.data.datasets[0].data = data;
                mlChart.update();
            }
        }

        /**
         * Notify contract purchase
         */
        function notifyContractPurchase(details) {
            Toastify({
                text: `Contract Purchased: ${details.contractType} on ${details.symbol} for $${details.buyPrice} (ID: ${details.contractId})`,
                duration: 5000,
                gravity: 'top',
                position: 'right',
                backgroundColor: 'var(--success-color)',
                ariaLive: 'polite'
            }).showToast();
        }

        /**
         * Display data table
         */
        function displayDataTable(data, page) {
            const tableHeader = document.getElementById('data-table-header');
            const tableBody = document.getElementById('data-table-body');
            const pagination = document.getElementById('pagination');
            if (!tableHeader || !tableBody || !pagination) {
                console.warn('Data table elements not found');
                return;
            }

            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            pagination.innerHTML = '';

            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10">No data available</td></tr>';
                return;
            }

            const itemsPerPage = 10;
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedData = data.slice(start, end);

            // Generate headers
            const headers = Object.keys(paginatedData[0]).filter(key => key !== 'indicators' && key !== 'marketConditions');
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.charAt(0).toUpperCase() + header.slice(1);
                headerRow.appendChild(th);
            });
            tableHeader.appendChild(headerRow);

            // Generate rows
            paginatedData.forEach(item => {
                const row = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = item[header] || '-';
                    row.appendChild(td);
                });
                tableBody.appendChild(row);
            });

            // Generate pagination
            const totalPages = Math.ceil(data.length / itemsPerPage);
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = i === page ? 'active' : '';
                button.addEventListener('click', () => displayDataTable(data, i));
                pagination.appendChild(button);
            }
        }

        /**
         * Handle view data button
         */
        document.getElementById('view-data')?.addEventListener('click', () => {
            const dataType = document.getElementById('data-type')?.value;
            const { loadData } = window.derivBot ? window.derivBot : { loadData: () => [] };
            const data = loadData(dataType);
            displayDataTable(data, 1);
            Toastify({
                text: `Displayed ${dataType} data`,
                duration: 3000,
                gravity: 'top',
                position: 'right',
                backgroundColor: 'var(--success-color)',
                ariaLive: 'polite'
            }).showToast();
        });

        /**
         * Handle data import
         */
        document.getElementById('import-data')?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                const text = await file.text();
                const importedData = JSON.parse(text);
                localStorage.setItem('derivBotData', JSON.stringify(importedData));
                Toastify({
                    text: 'Data imported successfully',
                    duration: 3000,
                    gravity: 'top',
                    position: 'right',
                    backgroundColor: 'var(--success-color)',
                    ariaLive: 'polite'
                }).showToast();
                const dataType = document.getElementById('data-type').value;
                displayDataTable(importedData[dataType], 1);
                // Retrain ML model
                const { trainModel } = window.derivBot || {};
                if (trainModel) {
                    const trainingResult = trainModel();
                    if (!trainingResult.error) {
                        updateMLFeatureChart(trainingResult.featureImportance);
                    }
                }
            } catch (error) {
                Toastify({
                    text: `Error importing data: ${error.message}`,
                    duration: 5000,
                    gravity: 'top',
                    position: 'right',
                    backgroundColor: 'var(--error-color)',
                    ariaLive: 'assertive'
                }).showToast();
            }
        });
    </script>
    <script type="module" src="js/script.js"></script>
</body>
</html>
